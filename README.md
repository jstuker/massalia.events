# massalia.events

A cultural events aggregator for Marseille, featuring events in arts, music, dance, and theatre.

## Overview

massalia.events is a static website that aggregates cultural events from multiple sources in Marseille. The site is built with Hugo and automatically updated through a local crawler that fetches events from configured sources.

**Key Features:**
- Aggregates events from multiple cultural venues and platforms
- Automatic categorization (danse, musique, theatre, art, communaute)
- Location-based filtering (Marseille area)
- Multi-day event support
- Automatic event expiration (past events hidden from public view)
- Optimized images in WebP format
- French language support

## Project Structure

```
massalia.events/
├── content/
│   └── events/              # Event markdown files (generated by crawler)
│       └── 2026/01/27/      # Date-based folder structure
├── crawler/                 # Python crawler application
│   ├── crawl.py            # Main CLI entry point
│   ├── config.yaml         # Main configuration
│   ├── config/             # Source and criteria configuration
│   └── src/                # Crawler source code
├── docs/                   # Documentation
│   ├── WORKFLOW.md         # Publishing workflow guide
│   └── TROUBLESHOOTING.md  # Common issues and solutions
├── layouts/                # Hugo templates
├── scripts/                # Build and development scripts
│   ├── build.sh           # Production build
│   ├── serve.sh           # Development server
│   ├── clean.sh           # Clean build artifacts
│   ├── check-deps.sh      # Verify dependencies
│   └── maintenance/       # Maintenance utility scripts
├── static/
│   └── images/events/      # Event images (generated by crawler)
├── specifications/         # Product specifications
├── Makefile               # Convenient make targets
└── hugo.toml              # Hugo configuration
```

## Quick Start

### Prerequisites

- Python 3.11+
- Hugo (extended version)
- Git

### Setup

```bash
# Clone repository
git clone https://github.com/jstuker/massalia.events.git
cd massalia.events

# Set up crawler
cd crawler
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### Run Crawler

```bash
# Preview mode (recommended first)
python crawl.py run --dry-run

# Execute crawl
python crawl.py run
```

### Preview Site

```bash
cd ..

# Using make (recommended)
make serve

# Or directly with Hugo
hugo server

# Visit http://localhost:1313
```

### Publish

```bash
git add -A
git commit -m "Add events from crawl"
git push origin main
```

## Documentation

| Document | Description |
|----------|-------------|
| [Publishing Workflow](docs/WORKFLOW.md) | Step-by-step guide for daily operations |
| [Troubleshooting](docs/TROUBLESHOOTING.md) | Common issues and solutions |
| [Crawler Documentation](crawler/README.md) | Detailed crawler usage and configuration |
| [Product Specification](specifications/Product%20specification%20v1.md) | Project requirements and design |

## Daily Operations

See the [Publishing Workflow](docs/WORKFLOW.md) for detailed instructions.

**Quick checklist:**
1. `git pull origin main`
2. `cd crawler && source venv/bin/activate`
3. `python crawl.py run --dry-run` (preview)
4. `python crawl.py run` (execute)
5. `cd .. && git add -A && git commit -m "Add events"`
6. `git push origin main`

## Event Categories

| Category | French Label | Description |
|----------|--------------|-------------|
| danse | Danse | Dance performances and shows |
| musique | Musique | Concerts and music events |
| theatre | Théâtre | Theatre and performing arts |
| art | Art | Exhibitions and visual arts |
| communaute | Communauté | Community events and workshops |

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Run tests: `cd crawler && pytest`
5. Submit a pull request

See [Crawler README](crawler/README.md#adding-new-parsers) for adding new event sources.

## Build Scripts

The project includes shell scripts and a Makefile for local development:

### Using Make

```bash
make help          # Show all available targets
make serve         # Start development server
make build         # Production build
make clean         # Remove build artifacts
make check         # Verify dependencies
make crawl         # Run event crawler
make test          # Run tests
```

### Using Scripts Directly

```bash
./scripts/serve.sh              # Start dev server at localhost:1313
./scripts/serve.sh --network    # Allow network access
./scripts/build.sh              # Build for production
./scripts/build.sh --drafts     # Include draft content
./scripts/clean.sh              # Clean build artifacts
./scripts/check-deps.sh         # Check dependencies
```

### Script Options

| Script | Option | Description |
|--------|--------|-------------|
| serve.sh | `--no-drafts` | Exclude draft content |
| serve.sh | `--network` | Bind to 0.0.0.0 |
| serve.sh | `--port N` | Use custom port |
| build.sh | `--drafts` | Include drafts |
| build.sh | `--baseURL URL` | Override base URL |
| clean.sh | `--all` | Also clean node_modules |

## Maintenance

The project includes maintenance scripts for ongoing site health:

### Using Make

```bash
make maintenance       # Run all maintenance checks
make update-theme      # Update Blowfish theme to latest
make validate-config   # Validate Hugo configuration
make validate-content  # Check event front matter
make check-links       # Check for broken links
make expire-events     # List expired events
make cleanup           # Remove stale artifacts
```

### Maintenance Scripts

| Script | Description |
|--------|-------------|
| `update-theme.sh` | Check and update Blowfish theme submodule |
| `validate-config.sh` | Validate Hugo TOML configuration files |
| `check-links.sh` | Find broken internal/external links |
| `validate-content.sh` | Validate event markdown front matter |
| `cleanup.sh` | Remove temporary files and artifacts |
| `expire-events.sh` | Mark or delete past events |

### Script Options

| Script | Option | Description |
|--------|--------|-------------|
| update-theme.sh | `--update` | Update theme to latest version |
| update-theme.sh | `--version` | Show current version only |
| check-links.sh | `--external` | Also check external links |
| check-links.sh | `--images` | Verify image files exist |
| validate-content.sh | `--verbose` | Show all files checked |
| cleanup.sh | `--all` | Also clean orphaned images |
| cleanup.sh | `--dry-run` | Preview without deleting |
| expire-events.sh | `--mark` | Add expired: true to past events |
| expire-events.sh | `--delete` | Remove past events and images |
| expire-events.sh | `--days N` | Events older than N days |

## Event Expiration System

Past events are automatically hidden from the public website while remaining in the content repository for historical reference.

### How It Works

1. **Expiration Flag**: Each event has an `expired: false` field in its front matter
2. **Timezone**: Events expire at midnight Europe/Paris time after the event date
3. **Display**: Expired events are filtered from all listings (home, categories, tags, search)
4. **Direct Access**: Accessing an expired event URL shows a friendly "Cet événement est passé" message
5. **Preservation**: Expired event files remain in `/content/events/` for Git history

### Managing Expired Events

```bash
# List past events
make expire-events

# Mark past events as expired
make mark-expired

# Or use the script directly
./scripts/maintenance/expire-events.sh --mark

# Delete events older than 30 days
./scripts/maintenance/expire-events.sh --delete --days 30
```

### Event Front Matter

New events created by the crawler include:
```yaml
expired: false
expiryDate: 2026-01-28T00:00:00+01:00  # Hugo's built-in expiry
```

## Technology Stack

- **Static Site Generator:** Hugo 0.154.4+ (extended)
- **Theme:** Blowfish
- **Crawler:** Python 3.11+
- **Hosting:** GitHub Pages
- **CI/CD:** GitHub Actions

## License

Part of the Massalia Events project.
