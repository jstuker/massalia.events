{{/*
  Custom search index that excludes expired events
  This overrides the Blowfish default to filter out expired: true pages
*/}}
{{- $index := slice -}}
{{ $pages := .Site.Pages }}
{{ range .Site.Home.Translations }}
{{ $pages = $pages | lang.Merge .Site.Pages }}
{{ end }}
{{- range $pages -}}
  {{/* Skip pages marked for exclusion from search */}}
  {{- if not .Params.excludeFromSearch -}}
    {{/* Skip expired events */}}
    {{- if not .Params.expired -}}
      {{- $section := .Site.GetPage "section" .Section -}}
      {{- if .Date -}}
        {{- $index = $index | append (dict
        "date" (.Date | time.Format (.Site.Language.Params.dateFormat | default ":date_long"))
        "title" (.Title | emojify | safeJS)
        "section" ($section.Title | emojify | safeJS)
        "summary" (.Summary | plainify | htmlUnescape | safeJS)
        "content" (.Plain | safeJS)
        "permalink" .RelPermalink
        "externalUrl" .Params.externalUrl
        "type" .Type
        ) -}}
      {{- else -}}
        {{- $index = $index | append (dict
        "title" (.Title | emojify | safeJS)
        "section" ($section.Title | emojify | safeJS)
        "summary" (.Summary | plainify | htmlUnescape | safeJS)
        "content" (.Plain | safeJS)
        "permalink" .RelPermalink
        "externalUrl" .Params.externalUrl
        "type" .Type
        ) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $index | jsonify -}}
