{{/* Event card component for displaying event information */}}
{{/* Usage: {{ partial "event-card.html" . }} */}}
{{/* Expects a page context with event front matter */}}

{{ $page := . }}
{{ $showSourceBadge := false }}
{{ if reflect.IsMap . }}
  {{ $page = .page }}
  {{ $showSourceBadge = .showSourceBadge | default false }}
{{ end }}
{{ $disableImageOptimization := site.Params.disableImageOptimization | default false }}

{{/* French month abbreviations */}}
{{ $frenchMonths := dict
    "1" "jan"
    "2" "fév"
    "3" "mar"
    "4" "avr"
    "5" "mai"
    "6" "juin"
    "7" "juil"
    "8" "août"
    "9" "sep"
    "10" "oct"
    "11" "nov"
    "12" "déc"
}}

{{/* Category color mappings - using inline styles for reliable rendering */}}
{{ $categoryColors := dict
    "danse" "background-color: #ec4899; color: white;"
    "musique" "background-color: #a855f7; color: white;"
    "theatre" "background-color: #f59e0b; color: white;"
    "art" "background-color: #14b8a6; color: white;"
    "communaute" "background-color: #3b82f6; color: white;"
}}

{{/* Category gradient mappings for placeholder images */}}
{{ $categoryGradients := dict
    "danse" "background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);"
    "musique" "background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);"
    "theatre" "background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"
    "art" "background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);"
    "communaute" "background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"
}}

{{/* Get event image - prefer thumbnail for card display */}}
{{ $imageURL := "" }}
{{ $imgWidth := 0 }}
{{ $imgHeight := 0 }}
{{ with $page.Params.image }}
  {{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
    {{ $imageURL = . }}
  {{ else if ne . "" }}
    {{/* Try to get thumbnail version first (383x215 optimized for cards) */}}
    {{ $thumbPath := replaceRE `\.webp$` "-thumb.webp" . }}
    {{ $thumbImg := resources.Get $thumbPath }}
    {{ with $thumbImg }}
      {{ $imageURL = .RelPermalink }}
      {{ $imgWidth = .Width }}
      {{ $imgHeight = .Height }}
    {{ else }}
      {{/* Fall back to original image with resize */}}
      {{ $img := resources.Get . }}
      {{ with $img }}
        {{ if not $disableImageOptimization }}
          {{ $resized := .Resize "400x" }}
          {{ $imageURL = $resized.RelPermalink }}
          {{ $imgWidth = $resized.Width }}
          {{ $imgHeight = $resized.Height }}
        {{ else }}
          {{ $imageURL = .RelPermalink }}
          {{ $imgWidth = .Width }}
          {{ $imgHeight = .Height }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Fallback to page resources */}}
{{ if eq $imageURL "" }}
  {{ $images := $page.Resources.ByType "image" }}
  {{ range slice "*feature*" "*cover*" "*thumbnail*" }}
    {{ if eq $imageURL "" }}
      {{ $img := $images.GetMatch . }}
      {{ with $img }}
        {{ if not $disableImageOptimization }}
          {{ $resized := $img.Resize "400x" }}
          {{ $imageURL = $resized.RelPermalink }}
          {{ $imgWidth = $resized.Width }}
          {{ $imgHeight = $resized.Height }}
        {{ else }}
          {{ $imageURL = $img.RelPermalink }}
          {{ $imgWidth = $img.Width }}
          {{ $imgHeight = $img.Height }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Get category info */}}
{{ $categorySlug := "" }}
{{ $categoryTitle := "" }}
{{ $categoryColor := "background-color: #737373; color: white;" }}
{{ $categoryGradient := "background: linear-gradient(135deg, #737373 0%, #525252 100%);" }}
{{ with $page.Params.categories }}
  {{ $categorySlug = index . 0 }}
  {{ with site.GetPage (printf "/categories/%s" $categorySlug) }}
    {{ $categoryTitle = .Title }}
  {{ end }}
  {{ if eq $categoryTitle "" }}
    {{ $categoryTitle = $categorySlug | title }}
  {{ end }}
  {{ with index $categoryColors $categorySlug }}
    {{ $categoryColor = . }}
  {{ end }}
  {{ with index $categoryGradients $categorySlug }}
    {{ $categoryGradient = . }}
  {{ end }}
{{ end }}

{{/* Get location info */}}
{{ $locationTitle := "" }}
{{ with $page.Params.locations }}
  {{ $locationSlug := index . 0 }}
  {{ with site.GetPage (printf "/locations/%s" $locationSlug) }}
    {{ $locationTitle = .Title }}
  {{ end }}
  {{ if eq $locationTitle "" }}
    {{ $locationTitle = $locationSlug | humanize | title }}
  {{ end }}
{{ end }}

{{/* Get event name - fallback to title */}}
{{ $eventName := $page.Params.name | default $page.Params.eventName | default $page.Title }}

{{/* Format date in French */}}
{{ $eventDate := $page.Date }}
{{ $dayOfMonth := $eventDate.Day }}
{{ $monthNum := $eventDate.Month | int | string }}
{{ $monthName := index $frenchMonths $monthNum }}

{{/* Get start time */}}
{{ $startTime := $page.Params.startTime | default "" }}

{{/* Multi-day indicator */}}
{{ $dayOf := $page.Params.dayOf | default "" }}

<article class="event-card group relative flex flex-col overflow-hidden rounded-xl border border-neutral-200 bg-white shadow-sm transition-all duration-300 hover:shadow-lg hover:-translate-y-1 dark:border-neutral-700 dark:bg-neutral-800">
  {{/* Image section */}}
  <div class="aspect-[16/9] overflow-hidden bg-neutral-100 dark:bg-neutral-700" style="position: relative;">
    {{ if ne $imageURL "" }}
      <img
        src="{{ $imageURL }}"
        alt="{{ $eventName }}"
        {{ with $imgWidth }}width="{{ . }}"{{ end }}
        {{ with $imgHeight }}height="{{ . }}"{{ end }}
        loading="lazy"
        decoding="async"
        class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
      />
    {{ else }}
      {{/* Placeholder with category-based gradient */}}
      <div class="flex h-full w-full items-center justify-center transition-transform duration-300 group-hover:scale-105" style="{{ $categoryGradient | safeCSS }}">
        <svg class="h-16 w-16 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h12a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
      </div>
    {{ end }}

    {{/* Category badge - positioned over image */}}
    {{ if ne $categoryTitle "" }}
      <span style="position: absolute; left: 12px; top: 12px; z-index: 10; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; {{ $categoryColor | safeCSS }}">
        {{ $categoryTitle }}
      </span>
    {{ end }}
  </div>

  {{/* Content section */}}
  <div class="flex flex-1 flex-col p-4">
    {{/* Event name - clickable */}}
    <h3 class="mb-2 line-clamp-2 text-lg font-bold leading-tight text-neutral-900 dark:text-neutral-100">
      <a href="{{ $page.RelPermalink }}" class="before:absolute before:inset-0 hover:text-primary-500 dark:hover:text-primary-400">
        {{ $eventName }}
      </a>
    </h3>

    {{/* Location */}}
    {{ if ne $locationTitle "" }}
      <div class="mb-3 flex items-center gap-1.5 text-sm text-neutral-600 dark:text-neutral-400">
        <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <span class="truncate">{{ $locationTitle }}</span>
      </div>
    {{ end }}

    {{/* Source/crawler indicator */}}
    {{ if and $showSourceBadge $page.Params.sourceId }}
      {{ $sourceName := index (split $page.Params.sourceId ":") 0 }}
      <div class="mb-3 flex items-center gap-1.5 text-sm text-neutral-600 dark:text-neutral-400">
        <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
        </svg>
        <span class="truncate">Found on: {{ $sourceName }}</span>
      </div>
    {{ end }}

    {{/* Date and time row */}}
    <div class="mt-auto flex items-center justify-between border-t border-neutral-100 pt-3 dark:border-neutral-700">
      {{/* Date */}}
      <div class="flex items-center gap-1.5 text-sm text-neutral-600 dark:text-neutral-400">
        <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <span>{{ $dayOfMonth }} {{ $monthName }}</span>
      </div>

      {{/* Start time */}}
      {{ if ne $startTime "" }}
        <div class="flex items-center gap-1.5 text-sm font-semibold text-neutral-900 dark:text-neutral-100">
          <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>{{ $startTime }}</span>
        </div>
      {{ end }}
    </div>

    {{/* Multi-day indicator */}}
    {{ if ne $dayOf "" }}
      <div class="mt-2 text-center">
        <span class="inline-flex items-center rounded-md bg-neutral-100 px-2 py-1 text-xs font-medium text-neutral-600 dark:bg-neutral-700 dark:text-neutral-300">
          {{ $dayOf }}
        </span>
      </div>
    {{ end }}
  </div>
</article>
